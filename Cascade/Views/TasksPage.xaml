<UserControl x:Class="Cascade.Views.TasksPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Cascade.Views"
             xmlns:vm="clr-namespace:Cascade.ViewModels"
             xmlns:helpers="clr-namespace:Cascade.Helpers"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800"
             Background="Transparent">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Cascade;component/Styles/MediaStyles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            
            <helpers:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
            <helpers:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            
            <!-- ============================================== -->
            <!-- 顶部标题区域 - 基于 SideBarTop -->
            <!-- ============================================== -->
            <LinearGradientBrush x:Key="Brush_SectionTopBackground" StartPoint="0.5,0" EndPoint="0.5,1">
                <GradientStop Color="#FF5A5F6D" Offset="0.36"/>
                <GradientStop Color="#FF353A51" Offset="0.498"/>
                <GradientStop Color="#FF141B36" Offset="0.504"/>
                <GradientStop Color="#FF070918" Offset="0.706"/>
            </LinearGradientBrush>
            
            <!-- 顶部高光效果 -->
            <RadialGradientBrush x:Key="Brush_SectionTopHighlight" RadiusX="0.4" RadiusY="1.3" Center="0.5,0" GradientOrigin="0.5,0">
                <GradientStop Color="#FF79B6EE" Offset="0"/>
                <GradientStop Color="#004D4D4D" Offset="1"/>
            </RadialGradientBrush>

            <!-- 底部高光效果 -->
            <RadialGradientBrush x:Key="Brush_SectionTopBottomGlow" RadiusX="0.7" RadiusY="0.5" Center="0.5,1" GradientOrigin="0.5,1">
                <GradientStop Color="#FF43ACFF" Offset="0"/>
                <GradientStop Color="#004D4D4D" Offset="1"/>
            </RadialGradientBrush>
            
            <!-- 顶部边框画刷 -->
            <RadialGradientBrush x:Key="Brush_SectionTopBorder" RadiusX="4.4" RadiusY="1" Center="0.5,-1.7" GradientOrigin="0.5,-1.7">
                <RadialGradientBrush.RelativeTransform>
                    <RotateTransform CenterX="0.5" CenterY="-1.7" Angle="90"/>
                </RadialGradientBrush.RelativeTransform>
                <GradientStop Color="#00FFFFFF" Offset="0"/>
                <GradientStop Color="#FFFFFFFF" Offset="1"/>
            </RadialGradientBrush>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <!-- 任务页面 - 预览选中的媒体和操作设定 -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*" MinHeight="200"/>
            <RowDefinition Height="8"/>
            <RowDefinition Height="200" MinHeight="100"/>
        </Grid.RowDefinitions>

        <!-- 上部区域：媒体预览和操作设定 -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="300"/>
                <ColumnDefinition Width="8"/>
                <ColumnDefinition Width="*" MinWidth="300"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧：选中的媒体列表 -->
            <Border Grid.Column="0" BorderBrush="#33FFFFFF" BorderThickness="1" Background="#0DFFFFFF" CornerRadius="3">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- 标题栏 - 使用 SideBarTop 样式 -->
                    <Grid Grid.Row="0" Height="38">
                        <!-- 背景层 -->
                        <Border Background="{StaticResource Brush_SectionTopBackground}" 
                                BorderBrush="{StaticResource Brush_SectionTopBorder}" 
                                BorderThickness="1" 
                                CornerRadius="3,3,0,0"/>
                        <!-- 顶部高光 -->
                        <Border Background="{StaticResource Brush_SectionTopHighlight}" CornerRadius="3,3,0,0"/>
                        <!-- 底部高光 -->
                        <Border Background="{StaticResource Brush_SectionTopBottomGlow}" CornerRadius="3,3,0,0"/>
                        
                        <TextBlock Text="{DynamicResource Tasks_MediaList}" 
                                   Foreground="White" 
                                   FontSize="14" 
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"
                                   Margin="12,0"/>
                    </Grid>

                    <!-- 媒体列表（单选）- 使用媒体页面的缩略图样式 -->
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding MediaItems}"
                             SelectedItem="{Binding SelectedMediaItem}"
                             SelectionMode="Single"
                             Background="Transparent"
                             BorderThickness="0"
                             Foreground="White"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                             Style="{x:Null}"
                             Padding="5">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" ItemWidth="100" ItemHeight="120"/>
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <ContentPresenter/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <!-- 外层容器：整体布局 -->
                                <Grid Width="90" Height="110" Margin="5,5,5,5">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="90"/>
                                        <!-- 1:1 正方形缩略图区域 (90x90) -->
                                        <RowDefinition Height="*"/>
                                        <!-- 文件名区域 -->
                                    </Grid.RowDefinitions>

                                    <!-- ============================================== -->
                                    <!-- 缩略图容器：1:1 正方形，三层结构 -->
                                    <!-- ============================================== -->
                                    <Grid Grid.Row="0" Width="90" Height="90">

                                        <!-- 第一层：GlassBottom 基底层 -->
                                        <Rectangle x:Name="GlassBottom" Width="90" Height="90"
                                                   Fill="{StaticResource ThumbnailGlassBottomBrush}"/>

                                        <!-- 选中状态层：GlassBottomSelected (默认透明) -->
                                        <Rectangle x:Name="GlassBottomSelected" Width="90" Height="90"
                                                   Fill="{StaticResource ThumbnailGlassBottomSelectedBrush}"
                                                   Opacity="0"/>

                                        <!-- 第二层：16:9 缩略图框 (居中于1:1容器内) -->
                                        <Grid Width="82" Height="46.125"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center">
                                            <Border Background="{StaticResource ThumbnailLetterboxBrush}"
                                                    BorderBrush="{StaticResource ThumbnailFrameBorderBrush}"
                                                    BorderThickness="1"
                                                    CornerRadius="2">
                                                <Border.Clip>
                                                    <RectangleGeometry Rect="-3,0,82,46.125" RadiusX="2" RadiusY="2"/>
                                                </Border.Clip>
                                                <Grid>
                                                    <!-- 占位符 -->
                                                    <TextBlock Text="{DynamicResource Media_Placeholder_Thumbnail}"
                                                               Foreground="#66FFFFFF"
                                                               FontSize="9"
                                                               HorizontalAlignment="Center"
                                                               VerticalAlignment="Center"
                                                               Visibility="{Binding Thumbnail, Converter={StaticResource NullToVisibilityConverter}}"/>

                                                    <!-- 缩略图图像 -->
                                                    <Image Source="{Binding Thumbnail}"
                                                           Stretch="Uniform"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                                </Grid>
                                            </Border>
                                        </Grid>

                                        <!-- 第三层：GlassSlice 顶部高光覆盖层 -->
                                        <Rectangle Width="90" Height="90"
                                                   Fill="{StaticResource ThumbnailGlassSliceBrush}"
                                                   IsHitTestVisible="False"/>

                                    </Grid>

                                    <!-- 文件名标签 -->
                                    <TextBlock Grid.Row="1"
                                               Text="{Binding Name}"
                                               Foreground="White"
                                               FontSize="11"
                                               TextTrimming="CharacterEllipsis"
                                               TextWrapping="Wrap"
                                               MaxHeight="32"
                                               HorizontalAlignment="Center"
                                               TextAlignment="Center"
                                               Margin="2,4,2,0"
                                               ToolTip="{Binding Name}"/>
                                </Grid>
                                <DataTemplate.Triggers>
                                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetName="GlassBottomSelected"
                                                                     Storyboard.TargetProperty="Opacity"
                                                                     To="1" Duration="0:0:0.2">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseOut"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                        <DataTrigger.ExitActions>
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetName="GlassBottomSelected"
                                                                     Storyboard.TargetProperty="Opacity"
                                                                     To="0" Duration="0:0:0.4">
                                                        <DoubleAnimation.EasingFunction>
                                                            <QuadraticEase EasingMode="EaseIn"/>
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.ExitActions>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- 空状态提示 -->
                    <TextBlock Grid.Row="1" 
                               Text="{DynamicResource Tasks_NoMedia}" 
                               Foreground="#66FFFFFF" 
                               FontSize="14"
                               HorizontalAlignment="Center" 
                               VerticalAlignment="Center">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasMedia}" Value="False">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </Border>

            <!-- 分隔条 -->
            <GridSplitter Grid.Column="1" 
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          ResizeDirection="Columns"
                          ResizeBehavior="PreviousAndNext"
                          Background="#20FFFFFF"/>

            <!-- 右侧：操作设定预览 -->
            <Border Grid.Column="2" BorderBrush="#33FFFFFF" BorderThickness="1" Background="#0DFFFFFF" CornerRadius="3">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- 标题栏 - 使用 SideBarTop 样式 -->
                    <Grid Grid.Row="0" Height="38">
                        <!-- 背景层 -->
                        <Border Background="{StaticResource Brush_SectionTopBackground}" 
                                BorderBrush="{StaticResource Brush_SectionTopBorder}" 
                                BorderThickness="1" 
                                CornerRadius="3,3,0,0"/>
                        <!-- 顶部高光 -->
                        <Border Background="{StaticResource Brush_SectionTopHighlight}" CornerRadius="3,3,0,0"/>
                        <!-- 底部高光 -->
                        <Border Background="{StaticResource Brush_SectionTopBottomGlow}" CornerRadius="3,3,0,0"/>
                        
                        <TextBlock Text="{DynamicResource Tasks_OperationSettings}" 
                                   Foreground="White" 
                                   FontSize="14" 
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"
                                   Margin="12,0"/>
                    </Grid>

                    <!-- 设定列表 -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="10">
                        <StackPanel>
                            <!-- 后端 -->
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{DynamicResource Tasks_Backend}" Foreground="#AAFFFFFF" FontSize="11"/>
                                <TextBlock Grid.Column="1" Text="{Binding SelectedBackend}" Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                            </Grid>

                            <!-- 输出路径 -->
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{DynamicResource Tasks_OutputPath}" Foreground="#AAFFFFFF" FontSize="11"/>
                                <TextBlock Grid.Column="1" Text="{Binding OutputPath}" Foreground="White" FontSize="11" TextWrapping="Wrap"/>
                            </Grid>

                            <!-- 视频编码器 -->
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{DynamicResource Tasks_VideoEncoder}" Foreground="#AAFFFFFF" FontSize="11"/>
                                <TextBlock Grid.Column="1" Text="{Binding VideoEncoder}" Foreground="White" FontSize="11"/>
                            </Grid>

                            <!-- 视频编码模式 -->
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{DynamicResource Tasks_VideoMode}" Foreground="#AAFFFFFF" FontSize="11"/>
                                <TextBlock Grid.Column="1" Text="{Binding VideoMode}" Foreground="White" FontSize="11"/>
                            </Grid>

                            <!-- 输出尺寸 -->
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{DynamicResource Tasks_OutputSize}" Foreground="#AAFFFFFF" FontSize="11"/>
                                <TextBlock Grid.Column="1" Text="{Binding OutputSize}" Foreground="White" FontSize="11"/>
                            </Grid>

                            <!-- 输出格式 -->
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{DynamicResource Tasks_OutputFormat}" Foreground="#AAFFFFFF" FontSize="11"/>
                                <TextBlock Grid.Column="1" Text="{Binding OutputFormat}" Foreground="White" FontSize="11"/>
                            </Grid>

                            <!-- 更多设定... -->
                            <ItemsControl ItemsSource="{Binding AdditionalSettings}" Margin="0,10,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0,5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="120"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Key}" Foreground="#AAFFFFFF" FontSize="11"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Value}" Foreground="White" FontSize="11" TextWrapping="Wrap"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- 分隔条 -->
        <GridSplitter Grid.Row="1" 
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"
                      ResizeDirection="Rows"
                      ResizeBehavior="PreviousAndNext"
                      Background="#20FFFFFF"/>

        <!-- 下部区域：FFMPEG命令预览 -->
        <Border Grid.Row="2" BorderBrush="#33FFFFFF" BorderThickness="1" Background="#0DFFFFFF" CornerRadius="3">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 标题栏 -->
                <Border Grid.Row="0" Background="#20FFFFFF" BorderBrush="#20FFFFFF" BorderThickness="0,0,0,1" Padding="10,8">
                    <Grid>
                        <TextBlock Text="{DynamicResource Tasks_CommandPreview}" Foreground="White" FontSize="14" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        <Button Content="{DynamicResource Tasks_CopyCommand}" 
                                HorizontalAlignment="Right" 
                                Command="{Binding CopyCommandCommand}"
                                Padding="15,5"
                                FontSize="11"/>
                    </Grid>
                </Border>

                <!-- 命令文本 -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto" Padding="10">
                    <TextBox Text="{Binding CommandPreview, Mode=OneWay}" 
                             IsReadOnly="True"
                             Background="Transparent"
                             Foreground="#FFAAFFAA"
                             FontFamily="Consolas"
                             FontSize="11"
                             BorderThickness="0"
                             TextWrapping="Wrap"
                             VerticalScrollBarVisibility="Disabled"
                             HorizontalScrollBarVisibility="Disabled"/>
                </ScrollViewer>

                <!-- 底部操作栏 -->
                <Border Grid.Row="2" Background="#10FFFFFF" BorderBrush="#20FFFFFF" BorderThickness="0,1,0,0" Padding="10,8">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="{DynamicResource Tasks_RefreshPreview}" 
                                Command="{Binding RefreshPreviewCommand}"
                                Margin="0,0,10,0"
                                Padding="15,5"
                                FontSize="11"/>
                        <Button Content="{DynamicResource Tasks_AddToQueue}" 
                                Command="{Binding AddToQueueCommand}"
                                Padding="20,5"
                                FontSize="11"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>
