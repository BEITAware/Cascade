name: Build and Release Cascade

on:
  push:
    tags:
      - 'v*'
      - 'PublicBeta*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Checkout BEITAInstaller
      uses: actions/checkout@v4
      with:
        repository: BEITAware/BEITAInstaller
        path: BEITAInstaller
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Restore dependencies
      run: dotnet restore Cascade/Cascade.csproj
    
    - name: Restore NuGet packages for BEITAQuick
      run: |
        nuget restore BEITAInstaller/BEITAQuick/BEITAQuick.sln
    
    - name: Build BEITAQuick installer
      run: |
        msbuild BEITAInstaller/BEITAQuick/BEITAQuick/BEITAQuick.csproj `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:OutputPath=..\..\..\BEITAQuickBuild\
    
    - name: Publish Cascade application
      run: |
        dotnet publish Cascade/Cascade.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -o Cascade
    
    - name: Create Release structure
      run: |
        # Create Release folder structure
        New-Item -ItemType Directory -Force -Path "Release"
        New-Item -ItemType Directory -Force -Path "Release/App"
        New-Item -ItemType Directory -Force -Path "Release/App/CONTENT_1"
        New-Item -ItemType Directory -Force -Path "Release/App/CONTENT_1/CONTENT"
        
        # Copy BEITAQuick.exe to Release folder
        Copy-Item "BEITAQuickBuild/BEITAQuick.exe" -Destination "Release/BEITAQuick.exe"
        
        # Copy LICENSE to App folder as LICENSE.txt
        Copy-Item "Cascade/LICENSE" -Destination "Release/App/LICENSE.txt"
        
        # Create config.ini with Program Files location
        Set-Content -Path "Release/App/CONTENT_1/config.ini" -Value "C:\Program Files\Cascade"
        
        # Copy published Cascade folder to CONTENT
        Copy-Item -Path "Cascade" -Destination "Release/App/CONTENT_1/CONTENT" -Recurse -Force
    
    - name: Create Release archive
      run: |
        Compress-Archive -Path "Release/*" -DestinationPath "Cascade-Release.zip"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Cascade-Release.zip
          Release/BEITAQuick.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload Release artifact
      uses: actions/upload-artifact@v4
      with:
        name: Cascade-Release
        path: Release/
